<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" id="tab-favicon" href="favicon.png" />
  <title id="t">Gamo Launchpad</title>
  <link rel="stylesheet" href="/assets/css/global.css?v=7" />
  <link rel="stylesheet" href="/assets/css/music-player.css?v=2" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    
    /* Content iframe - takes full screen */
    #content-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      z-index: 1;
    }
    
    /* Music player container - floats above */
    #music-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      pointer-events: none;
    }
    
    #music-container > * {
      pointer-events: auto;
    }
    
    /* Mini floating controls for in-game */
    .mini-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 50px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .mini-controls.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .mini-controls .mini-btn {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .mini-controls .mini-btn:hover {
      background: rgba(139, 92, 246, 0.3);
    }
    
    .mini-controls .mini-title {
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.85rem;
      color: #fff;
    }
    
    .mini-controls .mini-art {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    /* Expand button to show full player */
    .mini-controls .expand-btn {
      background: linear-gradient(135deg, #8B5CF6, #3B82F6);
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <!-- Content iframe - loads pages here -->
  <iframe id="content-frame" src="/home"></iframe>
  
  <!-- Mini controls for in-game (hidden by default) -->
  <div class="mini-controls" id="mini-controls">
    <img class="mini-art" id="mini-art" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%231a1a1a' width='100' height='100'/%3E%3C/svg%3E" alt="">
    <span class="mini-title" id="mini-title">Not playing</span>
    <button class="mini-btn" id="mini-prev"><i class="fa-solid fa-backward-step"></i></button>
    <button class="mini-btn" id="mini-play"><i class="fa-solid fa-play"></i></button>
    <button class="mini-btn" id="mini-next"><i class="fa-solid fa-forward-step"></i></button>
    <button class="mini-btn expand-btn" id="mini-expand"><i class="fa-solid fa-chevron-up"></i></button>
  </div>
  
  <!-- Music player container -->
  <div id="music-container"></div>

  <script src="/assets/js/music-player.js?v=3"></script>
  <script>
    // Track current path for history
    let currentPath = '/home';
    
    // Global navigation function - loads content in iframe
    window.navigateTo = function(url) {
      const frame = document.getElementById('content-frame');
      
      // Normalize the URL
      let targetUrl = url;
      if (url.startsWith('#')) {
        targetUrl = url.substring(1);
      }
      
      // Update iframe
      frame.src = targetUrl;
      currentPath = targetUrl;
      
      // Update URL hash for bookmarking (without triggering hashchange)
      const newHash = '#' + targetUrl;
      if (window.location.hash !== newHash) {
        history.pushState({ path: targetUrl }, '', newHash);
      }
      
      // Show mini controls when viewing games, hide on menu pages
      const isGame = targetUrl.includes('/rx') || targetUrl.includes('/g/') || targetUrl.includes('game');
      document.getElementById('mini-controls').classList.toggle('visible', isGame);
      
      // Show/hide full player based on context
      const player = document.getElementById('music-player');
      if (player) {
        player.style.display = isGame ? 'none' : 'flex';
      }
    };
    
    // Handle browser back/forward buttons
    window.addEventListener('popstate', (event) => {
      if (event.state && event.state.path) {
        const frame = document.getElementById('content-frame');
        frame.src = event.state.path;
        currentPath = event.state.path;
      } else if (window.location.hash) {
        const path = window.location.hash.substring(1);
        const frame = document.getElementById('content-frame');
        frame.src = path;
        currentPath = path;
      }
    });
    
    // On initial load, check for hash path
    document.addEventListener('DOMContentLoaded', () => {
      if (window.location.hash && window.location.hash.length > 1) {
        const path = window.location.hash.substring(1);
        navigateTo(path);
      } else {
        // Set initial state
        history.replaceState({ path: '/home' }, '', '#/home');
      }
    });
    
    // Intercept navigation from iframe
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'navigate') {
        navigateTo(event.data.url);
      }
    });
    
    // Mini controls event handlers
    document.getElementById('mini-prev').addEventListener('click', () => {
      if (window.gamoMusicPlayer) window.gamoMusicPlayer.playPrev();
    });
    
    document.getElementById('mini-play').addEventListener('click', () => {
      if (window.gamoMusicPlayer) window.gamoMusicPlayer.togglePlay();
    });
    
    document.getElementById('mini-next').addEventListener('click', () => {
      if (window.gamoMusicPlayer) window.gamoMusicPlayer.playNext();
    });
    
    document.getElementById('mini-expand').addEventListener('click', () => {
      const player = document.getElementById('music-player');
      const mini = document.getElementById('mini-controls');
      if (player) {
        player.style.display = 'flex';
        mini.classList.remove('visible');
      }
    });
    
    // Sync mini controls with player state
    setInterval(() => {
      const mp = window.gamoMusicPlayer;
      if (!mp) return;
      
      const miniPlay = document.getElementById('mini-play');
      const miniArt = document.getElementById('mini-art');
      const miniTitle = document.getElementById('mini-title');
      
      if (mp.isPlaying) {
        miniPlay.innerHTML = '<i class="fa-solid fa-pause"></i>';
      } else {
        miniPlay.innerHTML = '<i class="fa-solid fa-play"></i>';
      }
      
      if (mp.queue.length > 0 && mp.currentIndex >= 0) {
        const song = mp.queue[mp.currentIndex];
        miniArt.src = song.thumbnail;
        miniTitle.textContent = song.title;
      }
    }, 500);
  </script>
</body>
</html>
